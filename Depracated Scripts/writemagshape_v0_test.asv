clc
clear all
close all

addpath("C:\Users\Zain\Documents\_Research\Mars\Slepian Libraries\slepian_alpha-master");
addpath("C:\Users\Zain\Documents\_Research\Mars\Slepian Libraries\slepian_golf-master");
addpath("C:\Users\Zain\Documents\_Research\Mars\Slepian Libraries\slepian_hotel-master");
addpath("C:\Users\Zain\Documents\_Research\Mars\Slepian Libraries\slepian_hotel-master\MGS");

baseFileName = 'mvn_mag_dummy_2.sts';
downsample = 1;
clon = 137;
clat = -5;
Th = 100;
h = 45000-3390;

%% initial
disp("initial");

[posX,posY,posZ,magX,magY,magZ]=loadpds(baseFileName);

disp("magX");
disp(magX);
disp(length(magX));

[lon,~,~,~,~,~,~,~]=MAGcart2sph(...
     posX,posY,posZ,magX,magY,magZ,[],[],[],[],[],[],[],[],[]);

disp("lon");
disp(lon);
disp(length(lon));

%% spherical cut
disp("spherical cut");

[posX,posY,posZ,magX,magY,magZ]=loadpds(baseFileName);

[lon,~,~,~,~,~,~,~]=MAGcart2sph( ...
    posX,posY,posZ,magX,magY,magZ,[],[],[],[],[],[],[],[],[],[clon clat Th]);

disp("magX");
disp(magX);
disp(length(magX));

disp("lon");
disp(lon);
disp(length(lon));


%% height cut
disp("height cut");

[posX,posY,posZ,magX,magY,magZ]=loadpds(baseFileName);

[lon,~,r,~,~,~,~,~]=MAGcart2sph( ...
    posX,posY,posZ,magX,magY,magZ,[],[],[],[],[],[],[],[],[]);

indices = find(r<3390+h);
magXX = magX(indices);
lonn = lon(indices);

disp("magXX");
disp(magXX);
disp(length(magXX));

disp("lonn");
disp(lonn);
disp(length(lonn));


%% spherical -> height cut
disp("spherical -> height cut");


[posX,posY,posZ,magX,magY,magZ]=loadpds(baseFileName);

[lon,~,r,~,~,~,~,~]=MAGcart2sph( ...
    posX,posY,posZ,magX,magY,magZ,[],[],[],[],[],[],[],[],[],[clon clat Th]);

indices = find(r<3390+h);
magXX = magX(indices);
lonn = lon(indices);

disp("magXX");
disp(magXX);
disp(length(magXX));

disp("lonn");
disp(lonn);
disp(length(lonn));

%% height -> spherical cut
disp("height -> spherical cut");

[posX,posY,posZ,magX,magY,magZ]=loadpds(baseFileName);

indices = find(r<3390+h);
magXX = magX(indices);

[lon,~,r,~,~,~,~,~]=MAGcart2sph( ...
    posX,posY,posZ,magX,magY,magZ,[],[],[],[],[],[],[],[],[],[clon clat Th]);

lonn = lon(indices);

disp("magXX");
disp(magXX);
disp(length(magXX));

disp("lonn");
disp(lonn);
disp(length(lonn));


%% create shape file

[dlon,dcola,dr]=dcart2dsph(lonn,latt,magXX,magYY,magZZ);
explon = rad2deg((lonn));
explat = rad2deg((latt));
B = sqrt(dlon.^2 + dcola.^2 + dr.^2);
% index2 = find(explon > 180);
% explon(index2) = -360 + explon(index2);
explat = 90-explat;
expheight = height - 3390;
Bval = B;
Br = dr;
Blon = dlon;
Bcola = dcola;
lonval = explon;
latval = explat;
heightval = expheight;
test2 = struct('Geometry', 'Multipoint','B',num2cell(Bval),'Br',num2cell(Br),'Blon',num2cell(Blon),'Bcola',num2cell(Bcola),'Height',num2cell(heightval),'Lon', num2cell(lonval), 'Lat',num2cell(latval));
splitStr = regexp(baseFileName,expression,'split');

%% write to shape file
if numel(B) > 1
shapewrite(test2, splitStr{1});
end
% end